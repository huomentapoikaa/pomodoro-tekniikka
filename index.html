<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Tekniikka & Muistiinpanot</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Playfair+Display:wght@700&family=Roboto:wght@400&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        /* ---------------------------------------------------- */
        /* YLEISET TYYLIT & TEEMA */
        /* ---------------------------------------------------- */
        :root {
            --bg-color: #0d0d0d;
            --text-color: #f0f0f0;
            --work-accent: #ff7f00; /* Ty√∂: Oranssi */
            --break-accent: #00bcd4; /* Tauko: Turkoosi */
            --inactive-color: #2a2a2a;
            --font-display: 'Inter', sans-serif;
            --progress: 360deg; 
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: var(--font-display);
            user-select: none;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            position: relative;
            overflow-x: hidden; 
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 40px;
            color: var(--work-accent);
            letter-spacing: 2px;
            font-weight: 900;
            z-index: 10;
        }
        
        #background-video {
            position: fixed;
            top: 50%;
            left: 50%;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            z-index: 0;
            transform: translate(-50%, -50%);
            object-fit: cover;
            opacity: 0.6; 
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1;
        }

        #timer-container, #controls, #utility-buttons {
            z-index: 10;
        }

        #timer-container {
            width: 350px;
            height: 350px;
            position: relative;
            background: var(--inactive-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.7), inset 0 0 15px rgba(255, 255, 255, 0.1);
        }

        .timer-ring {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(var(--work-accent) var(--progress), var(--inactive-color) var(--progress));
        }

        #timer-display {
            position: relative;
            background-color: var(--bg-color);
            width: 90%;
            height: 90%;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #time-text {
            font-size: 5rem;
            font-weight: 900;
            margin-top: 10px;
            letter-spacing: 3px;
            color: var(--work-accent);
        }

        #mode-text {
            font-size: 1.4rem;
            text-transform: uppercase;
            font-weight: 400;
            color: #aaa;
            margin-bottom: 5px;
        }

        .break #time-text, .break h1 {
            color: var(--break-accent);
        }
        
        .control-btn {
            background-color: var(--inactive-color);
            color: var(--text-color);
            border: 2px solid var(--work-accent);
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, border-color 0.5s;
            margin: 5px;
        }
        
        .break .control-btn { border-color: var(--break-accent); }
        .control-btn:hover { background-color: #3a3a3a; }
        .control-btn:active { transform: scale(0.98); }
        
        #utility-buttons {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 50;
        }

        .utility-btn {
            background: var(--inactive-color);
            color: var(--text-color);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            transition: background-color 0.2s;
        }
        
        /* ---------------------------------------------------- */
        /* MODAALIT (Asetukset & Muistiinpanot) */
        /* ---------------------------------------------------- */
        .app-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .app-modal.visible {
            opacity: 1;
            pointer-events: all;
        }

        .settings-content {
            background: #1e1e1e;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            margin: 50px 0;
        }
        
        #notes-modal .notes-content {
            background: #1e1e1e;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 800px; 
            margin: 50px 0;
            max-height: 90vh; 
            overflow-y: auto; 
        }

        .settings-content h2, .notes-content h2 {
            border-bottom: 2px solid var(--work-accent);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .setting-group {
            margin-bottom: 25px;
            text-align: left;
        }

        .setting-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: var(--work-accent);
        }
        
        .setting-group input[type="number"], .setting-group input[type="range"], #notes-modal .setting-group input[type="text"] {
            padding: 10px;
            width: 100%;
            border-radius: 6px;
            border: 1px solid #444;
            background: #333;
            color: var(--text-color);
        }
        
        /* √Ñ√§nenvoimakkuuden s√§√§timen tyyli */
        .setting-group input[type="range"] {
            padding: 0;
            height: 8px;
            cursor: pointer;
            -webkit-appearance: none;
            background: #444;
        }
        .setting-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: var(--work-accent);
            cursor: pointer;
        }
        
        .theme-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .theme-btn {
            padding: 10px 5px;
            background: var(--inactive-color);
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .theme-btn.active {
            border-color: var(--work-accent);
            background: #3a3a3a;
        }

        /* ---------------------------------------------------- */
        /* MUISTIINPANOT LOHKO */
        /* ---------------------------------------------------- */
        
        #notes-editor {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
        }
        
        #notes-input {
            width: 100%;
            height: 300px;
            border: 1px solid #ccc;
            padding: 15px;
            box-sizing: border-box;
            resize: vertical;
            font-size: 1.1rem;
            line-height: 1.5;
            color: #333;
            background-color: #fff;
            font-family: 'Roboto', sans-serif;
        }

        #char-count {
            display: block;
            margin-bottom: 15px;
            text-align: right;
            color: #777;
            font-size: 0.9rem;
        }
        
        .image-selectors {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 20px;
        }

        .image-selector-group {
            flex: 1;
            text-align: left;
        }
        
        .image-selector-group select {
            width: 100%;
            padding: 10px;
            border-radius: 4px;
            background: #333;
            color: var(--text-color);
            border: 1px solid #444;
            margin-top: 5px;
        }

        .action-btn {
            background-color: var(--break-accent);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s;
            margin: 5px;
        }
        .action-btn:hover { background-color: #00a0b2; }
        
        #board-preview-container {
            margin-top: 30px;
            display: none;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 8px;
        }

        #board-preview-container h3 {
            color: var(--work-accent);
            margin-bottom: 15px;
        }

        /* ---------------------------------------------------- */
        /* TAULUN TYYLIT (TUMMA TEEMA) */
        /* ---------------------------------------------------- */
        
        #memo-board-container {
            width: 700px;
            margin: 20px auto;
            position: relative;
        }
        
        #memo-board {
            width: 100%;
            min-height: 800px; 
            padding: 40px;
            border: 1px solid var(--text-color); 
            background: #1e1e1e; 
            position: relative;
            text-align: left;
            overflow: hidden;
            color: var(--text-color); 
        }

        #board-title {
            font-family: 'Playfair Display', serif;
            font-size: 2.8rem;
            color: var(--work-accent); 
            border-bottom: 3px double #777;
            padding-bottom: 10px;
            margin-bottom: 25px;
            text-align: center;
        }
        
        #board-content {
            font-family: 'Roboto', sans-serif;
            font-size: 1.2rem;
            line-height: 1.8;
            white-space: pre-wrap;
            margin-top: 20px;
            color: var(--text-color); 
            margin-right: 180px; 
            padding-right: 10px; 
        }
        
        .board-image {
            position: absolute;
            width: 150px;
            height: 150px; 
            border: 5px solid #2a2a2a; 
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            object-fit: cover; 
            z-index: 5; 
        }

        #img-top-right {
            top: 40px; 
            right: 40px; 
            transform: rotate(5deg);
        }

        #img-bottom-right {
            bottom: 40px; 
            right: 40px; 
            transform: rotate(-3deg);
        }
        
        /* ---------------------------------------------------- */
        /* TULOSTUSTYYLIT (Palautetaan paperiksi) */
        /* ---------------------------------------------------- */
        @media print {
            #utility-buttons, h1, #timer-container, #controls, .app-modal, #board-preview-container, .print-button-container {
                display: none;
            }
            
            #memo-board-container {
                position: static; 
                width: 100%;
                max-width: none;
                height: auto;
                margin: 0 auto;
            }
            #memo-board {
                display: block !important;
                border: 1px solid #000;
                box-shadow: none;
                page-break-after: always;
                min-height: 100vh;
                margin: 0 auto;
                background: #fff !important; 
            }
            body {
                color: #000 !important;
                background: #fff !important;
            }
            #board-title {
                color: #000 !important; 
                border-bottom: 3px double #000;
            }
            #board-content {
                color: #000 !important; 
                margin-right: 180px; 
            }
            .board-image {
                 border: 5px solid #fff; 
            }
        }
    </style>
</head>
<body class="work">
    
    <video id="background-video" autoplay loop muted src=""></video>
    <div class="overlay"></div>

    <div id="utility-buttons">
        <button id="notes-btn" class="utility-btn" onclick="toggleNotesModal()">üìù</button>
        <button id="settings-btn" class="utility-btn" onclick="toggleSettingsModal()">‚öôÔ∏è</button>
        <button id="fullscreen-btn" class="utility-btn" onclick="toggleFullscreen()">üì∫</button>
    </div>

    <h1>Pomodoro Tekniikka</h1>

    <div id="timer-container">
        <div class="timer-ring"></div>
        <div id="timer-display">
            <div id="mode-text">Ty√∂skentely</div>
            <div id="time-text">25:00</div>
        </div>
    </div>
    
    <div id="controls">
        <button id="start-pause-btn" class="control-btn" onclick="startPauseTimer()">‚ñ∂Ô∏è ALOITA</button>
        <button id="reset-btn" class="control-btn" onclick="resetTimer()">üîÅ Nollaa</button>
        <button id="skip-btn" class="control-btn" onclick="skipMode()">‚è≠Ô∏è Ohita Tila</button>
    </div>

    <div id="settings-modal" class="app-modal">
        <div class="settings-content">
            <h2>‚öôÔ∏è Asetukset</h2>
            
            <div class="setting-group">
                <h3>Ajankohdat (minuutteina)</h3>
                <label for="work-duration">Ty√∂skentelyjakso</label>
                <input type="number" id="work-duration" min="1" max="60" value="25">
                
                <label for="break-duration" style="margin-top: 15px;">Taukojakso</label>
                <input type="number" id="break-duration" min="1" max="60" value="5">
            </div>
            
            <div class="setting-group">
                <h3>Taustateemat (Video)</h3>
                <div class="theme-selection">
                    <button class="theme-btn active" data-video-url="https://cdn.pixabay.com/video/2020/08/30/48569-454825064_large.mp4">T√§htis√§de</button>
                    <button class="theme-btn" data-video-url="https://cdn.pixabay.com/video/2019/10/24/28236-368501609_large.mp4">Vesisade</button>
                    <button class="theme-btn" data-video-url="https://cdn.pixabay.com/video/2024/03/01/202587-918431513_large.mp4">Vihre√§ aalto</button>
                </div>
            </div>

            <button class="control-btn" style="width: 100%; margin-top: 20px;" onclick="saveSettings()">Tallenna ja Sulje</button>
        </div>
    </div>
    
    <div id="notes-modal" class="app-modal">
        <div class="notes-content">
            <h2>üìù Luo Muistiinpanotaulu</h2>
            
            <div class="setting-group" style="margin-bottom: 20px;">
                <label style="color: var(--work-accent);" for="board-title-input">Taulun Otsikko (max 50 merkki√§):</label>
                <input type="text" id="board-title-input" maxlength="50" value="">
            </div>

            <div class="image-selectors">
                <div class="image-selector-group">
                    <label style="color: var(--break-accent);" for="select-top-right">Kuva yl√§kulmaan:</label>
                    <select id="select-top-right"></select>
                </div>
                <div class="image-selector-group">
                    <label style="color: var(--break-accent);" for="select-bottom-right">Kuva alakulmaan:</label>
                    <select id="select-bottom-right"></select>
                </div>
            </div>

            <div id="notes-editor">
                <textarea id="notes-input" maxlength="1000" placeholder="Kirjoita t√§h√§n muistiinpanot (max 1000 merkki√§)."></textarea>
            </div>
            <span id="char-count">0 / 1000</span>

            <button class="action-btn" onclick="generateBoard()">‚úÖ Luo Taulu ja N√§yt√§ Esikatselu</button>
            <button class="control-btn" style="width: 100%; margin-top: 20px;" onclick="toggleNotesModal()">Sulje</button>

            <div id="board-preview-container">
                <h3>Esikatselu</h3>
                <div id="preview-actions" style="margin-bottom: 15px;">
                    <button class="action-btn" style="background-color: #ff7f00;" onclick="saveImage()">‚¨áÔ∏è Tallenna Kuva (.png)</button>
                    <button class="action-btn" style="background-color: #ff7f00;" onclick="printBoard()">üñ®Ô∏è Tulosta Taulu</button>
                </div>
                
                <div id="board-preview-placeholder">
                    </div>
            </div>
        </div>
    </div>
    
    <div id="memo-board-container" style="position: absolute; top: -9999px; left: -9999px;">
        <div id="memo-board">
            <img id="img-top-right" class="board-image" src="" alt="Yl√§kulman kuva">
            <img id="img-bottom-right" class="board-image" src="" alt="Alakulman kuva">

            <div id="board-title"></div>
            <div id="board-content"></div>
        </div>
    </div>
    
    <audio id="alarm-sound" src="https://www.soundjay.com/misc/sounds/bell-ringing-01.mp3" preload="auto"></audio>
    <script>
        // --- YDIN MUUTTUJAT ---
        let WORK_TIME = (parseInt(localStorage.getItem('workDuration')) || 25) * 60; 
        let BREAK_TIME = (parseInt(localStorage.getItem('breakDuration')) || 5) * 60;
        // let savedVolume = parseFloat(localStorage.getItem('musicVolume')) || 0.3; // POISTETTU
        let timeLeft = WORK_TIME;
        let isRunning = false;
        let timerInterval = null;
        let isWorkMode = true;
        let totalTime = WORK_TIME;
        
        // let isMusicPlaying = false; // POISTETTU
        const MAX_CHARS = 1000;
        
        const IMAGE_OPTIONS = [
            { name: "Kahvi/Focus", url: "https://cdn.pixabay.com/photo/2017/07/17/00/58/coffee-2511065_1280.jpg" },
            { name: "Opiskelu/Learning", url: "https://cdn.pixabay.com/photo/2015/05/29/19/17/study-789631_1280.jpg" },
            { name: "Koiranpennut", url: "https://cdn.pixabay.com/photo/2019/03/26/22/17/dog-4083794_1280.jpg" },
            { name: "Aivot/Brain", url: "https://cdn.pixabay.com/photo/2025/01/25/19/12/brain-9359621_1280.jpg" },
            { name: "Luokkahuone", url: "https://cdn.pixabay.com/photo/2025/07/02/14/57/classroom-9692540_1280.jpg" },
            { name: "Allan Kardec", url: "https://cdn.pixabay.com/photo/2025/11/22/04/39/allan-kardec-9970432_1280.jpg" },
            { name: "Abstrakti Aalto", url: "https://cdn.pixabay.com/photo/2020/07/04/15/49/art-5370016_1280.jpg" }
        ];

        // --- ELEMENTIT ---
        const body = document.body;
        const timeText = document.getElementById('time-text');
        const startPauseBtn = document.getElementById('start-pause-btn');
        const timerRing = document.querySelector('.timer-ring');
        const backgroundVideo = document.getElementById('background-video');
        const alarmSound = document.getElementById('alarm-sound');
        // Musiikkiin liittyv√§t elementit POISTETTU
        const settingsModal = document.getElementById('settings-modal');
        const notesModal = document.getElementById('notes-modal');
        const notesInput = document.getElementById('notes-input');
        const charCount = document.getElementById('char-count');
        const boardContent = document.getElementById('board-content');
        const memoBoard = document.getElementById('memo-board');
        const boardPreviewContainer = document.getElementById('board-preview-container');
        const boardPreviewPlaceholder = document.getElementById('board-preview-placeholder');
        const selectTopRight = document.getElementById('select-top-right');
        const selectBottomRight = document.getElementById('select-bottom-right');
        const imgTopRight = document.getElementById('img-top-right');
        const imgBottomRight = document.getElementById('img-bottom-right');
        const boardTitleDisplay = document.getElementById('board-title');
        const boardTitleInput = document.getElementById('board-title-input');

        // backgroundMusic.volume = savedVolume; // POISTETTU
        
        // --- POMODORO/AJASTIN LOGIIKKA ---
        
        function updateDisplay() {
            const minutes = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const seconds = (timeLeft % 60).toString().padStart(2, '0');
            timeText.textContent = `${minutes}:${seconds}`;
            const angle = (1 - (timeLeft / totalTime)) * 360; 
            timerRing.style.setProperty('--progress', `${angle}deg`);
        }
        
        function toggleMode(workMode) {
            isWorkMode = workMode;
            totalTime = workMode ? WORK_TIME : BREAK_TIME;
            timeLeft = totalTime;
            document.getElementById('mode-text').textContent = workMode ? 'Ty√∂skentely' : 'Tauko';
            body.className = workMode ? 'work' : 'break';
            updateDisplay();
        }

        function startPauseTimer() {
            if (!isRunning) {
                // ILMOITUSTEN KYSYMINEN
                requestNotificationPermission();

                // Musiikin toisto POISTETTU
                
                // Videon toisto
                if (backgroundVideo.src) {
                    backgroundVideo.play().catch(e => console.log("Videon toisto estettiin."));
                }
            }
            if (isRunning) {
                clearInterval(timerInterval);
                startPauseBtn.innerHTML = '‚ñ∂Ô∏è JATKA';
            } else {
                timerInterval = setInterval(countdown, 1000);
                startPauseBtn.innerHTML = '‚è∏Ô∏è KESKEYT√Ñ';
            }
            isRunning = !isRunning;
        }

        function countdown() {
            timeLeft--;
            updateDisplay();
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                isRunning = false;
                startPauseBtn.innerHTML = '‚ñ∂Ô∏è ALOITA';
                alarmSound.play(); 
                
                const nextMode = !isWorkMode;
                const alertMsg = isWorkMode ? "Ty√∂aika loppui! Aloita tauko." : "Tauko loppui! Takaisin t√∂ihin.";
                
                // L√§het√§ ty√∂p√∂yt√§ilmoitus
                sendNotification(alertMsg);
                
                alert(alertMsg);
                toggleMode(nextMode);
            }
        }

        function resetTimer() {
            clearInterval(timerInterval);
            isRunning = false;
            startPauseBtn.innerHTML = '‚ñ∂Ô∏è ALOITA';
            timeLeft = totalTime;
            updateDisplay();
        }

        function skipMode() {
            clearInterval(timerInterval);
            isRunning = false;
            startPauseBtn.innerHTML = '‚ñ∂Ô∏è ALOITA';
            toggleMode(!isWorkMode);
        }

        document.addEventListener('keydown', (e) => {
            if (settingsModal.classList.contains('visible') || notesModal.classList.contains('visible') || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            if (e.code === 'Space') {
                e.preventDefault(); 
                startPauseTimer();
            } else if (e.key.toLowerCase() === 'r') {
                e.preventDefault();
                resetTimer();
            }
        });

        // --- ILMOITUSFUNKTIOT ---
        
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log("Ilmoitukset sallittu!");
                    }
                });
            }
        }

        function sendNotification(title) {
            if ('Notification' in window && Notification.permission === 'granted') {
                // L√§het√§ ilmoitus vain, jos k√§ytt√§j√§ katsoo toista v√§lilehte√§
                if (document.hidden) { 
                    new Notification(title, {
                        body: "Palaa Pomodoro-ajastimeen jatkaaksesi.",
                        icon: "https://cdn.pixabay.com/photo/2017/07/17/00/58/coffee-2511065_1280.jpg" 
                    });
                }
            }
        }

        // --- MUSIIKIN/TAUSTAN VAIHTO LOGIIKKA ---
        
        // Musiikin √§√§nenvoimakkuuden s√§√§din POISTETTU
        
        // toggleMusic() funktio POISTETTU
        
        function handleMediaSelection(type, btn) {
            const url = btn.dataset[type + 'Url'];
            
            document.querySelectorAll(`.${type}-btn`).forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            if (type === 'video') {
                backgroundVideo.src = url;
                backgroundVideo.load();
                backgroundVideo.play().catch(e => console.log(`Videon toistoa ei voitu aloittaa automaattisesti: ${e}`));
            } 
            
            localStorage.setItem(`active${type.charAt(0).toUpperCase() + type.slice(1)}`, url);
        }
        
        // Asetetaan kuuntelijat heti DOMin latauduttua
        document.addEventListener('DOMContentLoaded', () => {
             document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.addEventListener('click', () => handleMediaSelection('video', btn));
            });
        });
        
        function updateSettingButtons() {
            const activeVideo = localStorage.getItem('activeVideo') || 'https://cdn.pixabay.com/video/2020/08/30/48569-454825064_large.mp4';
            
            // Asettaa Video-napin aktiiviseksi
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.videoUrl === activeVideo) {
                    btn.classList.add('active');
                    backgroundVideo.src = activeVideo;
                }
            });
        }

        // --- MODAALI- JA ASETUSLOGIIKKA ---
        function toggleSettingsModal() {
            document.getElementById('work-duration').value = WORK_TIME / 60;
            document.getElementById('break-duration').value = BREAK_TIME / 60;
            // musicVolumeSlider.value = backgroundMusic.volume * 100; // POISTETTU
            updateSettingButtons();
            settingsModal.classList.toggle('visible');
        }

        function saveSettings() {
            const newWorkMin = parseInt(document.getElementById('work-duration').value);
            const newBreakMin = parseInt(document.getElementById('break-duration').value);
            // Musiikin √§√§nenvoimakkuuden tallennus POISTETTU
            
            if (newWorkMin * 60 !== WORK_TIME || newBreakMin * 60 !== BREAK_TIME) {
                WORK_TIME = newWorkMin * 60;
                BREAK_TIME = newBreakMin * 60;
                localStorage.setItem('workDuration', newWorkMin);
                localStorage.setItem('breakDuration', newBreakMin);
                resetTimer();
            }
            toggleSettingsModal();
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    alert(`Virhe koko n√§yt√∂n tilassa: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }
        
        // --- MUISTIINPANOT LOGIIKKA ---

        function toggleNotesModal() {
            notesModal.classList.toggle('visible');
            if (notesModal.classList.contains('visible')) {
                 notesInput.focus();
            }
        }
        
        notesInput.addEventListener('input', () => {
            const currentLength = notesInput.value.length;
            charCount.textContent = `${currentLength} / ${MAX_CHARS}`;
            boardPreviewContainer.style.display = 'none'; 
        });

        boardTitleInput.addEventListener('input', () => {
            localStorage.setItem('boardTitle', boardTitleInput.value);
            boardPreviewContainer.style.display = 'none'; 
        });

        function populateImageSelectors() {
            IMAGE_OPTIONS.forEach((img, index) => {
                const option1 = new Option(img.name, img.url);
                const option2 = new Option(img.name, img.url);
                selectTopRight.add(option1);
                selectBottomRight.add(option2);
                
                // Asetetaan oletuskuvat
                if (index === 0) {
                    selectTopRight.value = img.url;
                } else if (index === 1) {
                    selectBottomRight.value = img.url;
                }
            });
            selectTopRight.addEventListener('change', (e) => imgTopRight.src = e.target.value);
            selectBottomRight.addEventListener('change', (e) => imgBottomRight.src = e.target.value);
        }

        function generateBoard() {
            const notes = notesInput.value.trim();
            // K√§ytet√§√§n tyhj√§√§, jos input on tyhj√§
            const customTitle = boardTitleInput.value.trim();
            
            if (notes.length === 0) {
                alert("Kirjoita ensin muistiinpanosi!");
                return;
            }
            
            let formattedNotes = notes
                .replace(/\n\s*\n/g, '\n\n') 
                .replace(/\n/g, '<br>');   

            formattedNotes = formattedNotes.replace(/(\*|\-)\s/g, '<span style="font-family: \'Playfair Display\', serif; color: var(--break-accent); font-size: 1.4rem;">‚Ä¢ </span>');
            
            boardContent.innerHTML = formattedNotes;
            
            boardTitleDisplay.textContent = customTitle;
            imgTopRight.src = selectTopRight.value;
            imgBottomRight.src = selectBottomRight.value;
            
            boardPreviewPlaceholder.innerHTML = '';
            const clonedBoard = memoBoard.cloneNode(true);
            clonedBoard.id = 'memo-board-preview';
            clonedBoard.style.position = 'static';
            clonedBoard.style.border = '1px dashed #777';
            clonedBoard.style.boxShadow = 'none';
            clonedBoard.style.minHeight = '600px'; 

            boardPreviewPlaceholder.appendChild(clonedBoard);
            
            boardPreviewContainer.style.display = 'block';
            
            // Vieritet√§√§n notes-modalin sis√§lt√∂ alas esikatseluun
            const notesContent = document.querySelector('#notes-modal .notes-content');
            notesContent.scrollTo({ top: notesContent.scrollHeight, behavior: 'smooth' });

            alert("Taulu luotu! Vierit√§ modalin sis√§ll√§ n√§hd√§ksesi esikatselun ja tallennusvaihtoehdot.");
        }

        function saveImage() {
            const targetElement = document.getElementById('memo-board-preview');
            
            if (!targetElement) {
                alert("Luo taulu ensin 'Luo Taulu' -napilla.");
                return;
            }
            
            const container = document.getElementById('memo-board-container');
            container.style.position = 'absolute';
            container.style.top = '0';
            container.style.left = '0';
            container.style.zIndex = '9999';
            container.style.display = 'block';

            container.querySelector('#memo-board').innerHTML = targetElement.innerHTML;
            container.querySelector('#memo-board').style.border = 'none';

            html2canvas(container.querySelector('#memo-board'), {
                scale: 2, 
                allowTaint: true,
                useCORS: true 
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'Pomodoro_Muistiinpanotaulu.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(e => {
                alert("Virhe kuvan luomisessa. Kokeile Tulosta-toimintoa.");
            }).finally(() => {
                container.style.position = 'absolute';
                container.style.top = '-9999px';
                container.style.left = '-9999px';
            });
        }
        
        function printBoard() {
            window.print();
        }

        // --- ALUSTUS ---
        function init() {
            toggleMode(true); 
            
            const savedVideo = localStorage.getItem('activeVideo') || 'https://cdn.pixabay.com/video/2020/08/30/48569-454825064_large.mp4';
            
            backgroundVideo.src = savedVideo;
            
            // Musiikin tila POISTETTU
            
            // Asettaa videot/musiikit ja aktiiviset napit k√§ytt√∂liittym√§√§n
            updateSettingButtons(); 

            populateImageSelectors();
            notesInput.dispatchEvent(new Event('input')); 
            
            // KORJAUS: Muistiinpanotaulun otsikko on nyt tyhj√§ oletuksena
            boardTitleInput.value = localStorage.getItem('boardTitle') || "";
            boardTitleDisplay.textContent = boardTitleInput.value;
            
            imgTopRight.src = selectTopRight.value;
            imgBottomRight.src = selectBottomRight.value;
            
            document.getElementById('memo-board-container').style.display = 'none';
        }
        
        init();
    </script>
</body>
</html>
